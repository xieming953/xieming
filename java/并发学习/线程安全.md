#  线程安全

 ## 什么是线程安全

	- 当多个线程访问某个类时， 不论运行环境如何调度或者线程如何交替执行，在主调代码中不需要额外的同步措施，这个类的方法都能展现出良好的行为，这样的类可以称为线程安全的类

## 造成线程不安全的原因：重排序、不可见、非原子性

	- 编译器优化打乱程序执行顺序
	- 操作系统优化执行字节码，打乱字节码执行顺序
	- 操作系统主内存和处理器缓存的数据不一致性，以及jmm的工作内存和主内存的数据不一致性
	- 多核执行未加同步措施的代码时，可能会造成程序执行结果与预期不一致

## 解决办法

* CPU级别屏障: 指令顺序化、数据可见性
  
- lock 用来修饰当前指令操作的内存只能由当前CPU使用，若指令不操作内存仍然由用，因为这个修饰会让指令操作本身原子化，而且自带Full Barrior效果；还有指令比如IO操作的指令、exch等原子交换的指令，任何带有lock前缀的指令以及CPUID等指令都有内存屏障的作用
  
* java的同步措施: happen-before原则使得代码执行顺序可预测
  
  - 编译器级别sychronized（性能在java8之后在逐步优化，推荐使用）：可见性、原子性、顺序性
- volatile关键字：加volatile关键字之间的对象顺序性、可见性
  - 利用操作系统实现的cas操作：原子性
  - java程序依赖于AbstractQueuedSynchronizer(cas+volatile)实现的ReentrantLock，CountDownLatch、Semaphore（性能高，更灵活）：可见性、原子性、顺序性
  
  